"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function parse(e){var t=[],r=/^\s*#.*/;return e.split("\n").forEach(function(e){e.match(r)||t.push(_parseLine(e))}),t}function _parseLine(e){for(var t={line:e,lyrics:"",chords:[],directives:[]},r=/\[([a-zA-Z0-9#\/]+)\]/g,n=/\{\s*([^:}]*)\s*:{0,1}\s*([^:]*?)\s*}/g,i=[];l=r.exec(e);)l.type="chord",i.push(l);for(;l=n.exec(e);)l.type="directive",i.push(l);i.sort(function(e,t){return e.index-t.index});var s,l,o=0,a=!0,c=!1,u=void 0;try{for(var d,v=i[Symbol.iterator]();!(a=(d=v.next()).done);a=!0){var f=d.value;if(s=e.substring(o,f.index),s&&(t.lyrics+=s),"chord"==f.type){var h=0;if(t.chords.length>0){var g=t.chords[t.chords.length-1];h=Math.max(0,g.pos+g.value.length+1-t.lyrics.length)}for(var p=0;h>p;p++)t.lyrics+=" ";var y=f[0];t.chords.push({pos:t.lyrics.length,value:y.replace(/[\[\]]/g,"")}),o=f.index+y.length}else if("directive"==f.type){var _=f[0];t.directives.push({pos:t.lyrics.length,type:_getDirectiveType(f[1]),value:f[2]}),o=f.index+_.length}}}catch(m){c=!0,u=m}finally{try{!a&&v["return"]&&v["return"]()}finally{if(c)throw u}}return s=e.substring(o,e.length),s&&(t.lyrics+=s),t.lyrics=t.lyrics.replace(/\s+$/,""),t}function _getDirectiveType(e){return e=e.toLowerCase(),"t"===e?"title":"st"===e?"subtitle":"c"===e?"comment":e}function _formatParsedLine(e){for(var t=_getSegmentStartIndexes(e),r="",n=0;n<t.length;n++)r+='<div class="linefragment">',e.chords&&e.chords.length&&(r+=_getChordHtml(e.chords,t[n])),r+=_getLyricsHtml(e.lyrics,t[n],n<t.length-1?t[n+1]-1:null),r+="</div>";return r?'<div class="line">'+r+"</div>":""}function _getSegmentStartIndexes(e){function t(e,t){for(var r=e.index,n=1;t>n;n++)r+=e[n].length;return r}var r=[];if(e.lyrics&&e.lyrics.length>0)for(var n,i=/(\s*)(\w+)/g;n=i.exec(e.lyrics);){var s=t(n,2);_underscore2["default"].find(e.chords,function(e){return s>e.pos&&s<=e.pos+e.value.length})||r.push(s)}if(e.chords){var l=!0,o=!1,a=void 0;try{for(var c,u=e.chords[Symbol.iterator]();!(l=(c=u.next()).done);l=!0){var d=c.value;_underscore2["default"].contains(r,d.pos)||r.push(d.pos)}}catch(v){o=!0,a=v}finally{try{!l&&u["return"]&&u["return"]()}finally{if(o)throw a}}}return r.sort(function(e,t){return e-t}),r}function _getChordHtml(e,t){var r,n='<div class="chord">';return e&&(r=_underscore2["default"].find(e,function(e){return e.pos==t})),n+=r?r.value:"&nbsp;",n+="</div>"}function _getLyricsHtml(e,t,r){var n='<div class="lyrics">';return t>e.length-1?n+="&nbsp;":(r||(r=e.length-1),n+=e.substring(t,r+1)),n+="</div>"}function toHtml(e,t){var r='<div class="empty-line"></div>';e=(0,_sanitizeHtml2["default"])(e,{allowedTags:[],allowedAttributes:[]});var n=parse(e),i="",s=_getDirectiveValue(n,"title");s&&(i+='<div class="song-title">'+s+"</div>");var l=_getDirectiveValue(n,"subtitle");return l&&(i.length>0&&(i+=r),i+='<div class="song-subtitle">'+l+"</div>"),i.length>0&&(i+=r),n.forEach(function(e){i.length>0&&(e.lyrics.length>0||e.chords.length>0||0==e.line.length)&&(i+=r),i+=_formatParsedLine(e,r)}),i}function _getDirectiveValue(e,t){var r=!0,n=!1,i=void 0;try{for(var s,l=e[Symbol.iterator]();!(r=(s=l.next()).done);r=!0){var o=s.value;if(o.directives){var a=o.directives.find(function(e,r,n){return e.type===t});if(a)return a.value}}}catch(c){n=!0,i=c}finally{try{!r&&l["return"]&&l["return"]()}finally{if(n)throw i}}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.parse=parse,exports._getSegmentStartIndexes=_getSegmentStartIndexes,exports._getChordHtml=_getChordHtml,exports._getLyricsHtml=_getLyricsHtml,exports.toHtml=toHtml;var _sanitizeHtml=require("sanitize-html"),_sanitizeHtml2=_interopRequireDefault(_sanitizeHtml),_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);