"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function parse(e){var r=[],t=/^\s*#.*/;return e.split("\n").forEach(function(e){e.match(t)||r.push(_parseLine(e))}),r}function _parseLine(e){for(var r={line:e,lyrics:"",chords:[],directives:[]},t=/\[([a-zA-Z0-9#\/]+)\]/g,i=/\{\s*([^:}]*)\s*:{0,1}\s*([^:]*?)\s*}/g,n=[];l=t.exec(e);)l.type="chord",n.push(l);for(;l=i.exec(e);)l.type="directive",n.push(l);n.sort(function(e,r){return e.index-r.index});var s,l,o=0,a=!0,c=!1,u=void 0;try{for(var d,v=n[Symbol.iterator]();!(a=(d=v.next()).done);a=!0){var f=d.value;if(s=e.substring(o,f.index),s&&(r.lyrics+=s),"chord"==f.type){var g=f[0];r.chords.push({pos:r.lyrics.length,value:g.replace(/[\[\]]/g,"")}),o=f.index+g.length}else if("directive"==f.type){var h=f[0];r.directives.push({pos:r.lyrics.length,type:_getDirectiveType(f[1]),value:f[2]}),o=f.index+h.length}}}catch(p){c=!0,u=p}finally{try{!a&&v["return"]&&v["return"]()}finally{if(c)throw u}}return s=e.substring(o,e.length),s&&(r.lyrics+=s),r.lyrics=r.lyrics.replace(/\s+$/,""),r}function _getDirectiveType(e){return e=e.toLowerCase(),"t"===e?"title":"st"===e?"subtitle":"c"===e?"comment":e}function _formatParsedLine(e){var r=_getSegmentStartIndexes(e);if(0==e.line.length)return'<div class="line"><div class="linefragment"><div class="lyrics">&nbsp;</div></div></div>';for(var t="",i=!e.lyrics.match(/^\s*$/),n=0;n<r.length;n++)t+='<div class="linefragment">',e.chords&&e.chords.length&&(!i&&n>0&&(console.log(n,r[n],r[n-1]),t+=_getChordSpacerHtml(r[n]-r[n-1]-e.chords[n-1].value.length+1)),t+=_getChordHtml(e.chords,r[n])),i&&(t+=_getLyricsHtml(e.lyrics,r[n],n<r.length-1?r[n+1]-1:null)),t+="</div>";return t?'<div class="line">'+t+"</div>":""}function _getSegmentStartIndexes(e){function r(e,r){for(var t=e.index,i=1;r>i;i++)t+=e[i].length;return t}var t=[];if(e.lyrics)for(var i,n=/(\s*)([^\s]+)/g;i=n.exec(e.lyrics);){var s=r(i,2);_underscore2["default"].find(e.chords,function(e){return s>e.pos&&s<=e.pos+e.value.length})||t.push(s)}if(console.log(e),e.chords){var l=!0,o=!1,a=void 0;try{for(var c,u=e.chords[Symbol.iterator]();!(l=(c=u.next()).done);l=!0){var d=c.value;_underscore2["default"].contains(t,d.pos)||t.push(d.pos)}}catch(v){o=!0,a=v}finally{try{!l&&u["return"]&&u["return"]()}finally{if(o)throw a}}}return t.sort(function(e,r){return e-r}),t}function _getChordHtml(e,r){var t,i='<div class="chord">';return e&&(t=_underscore2["default"].find(e,function(e){return e.pos==r})),i+=t?t.value:"&nbsp;",i+="</div>"}function _getLyricsHtml(e,r,t){var i='<div class="lyrics">';if(r>e.length-1)for(var n=e.length-1;r>n;n++)i+="&nbsp;";else t||(t=e.length-1),i+=e.substring(r,t+1);return i+="</div>"}function _getChordSpacerHtml(e){for(var r='<div class="chord-spacer">',t=0;e>t;t++)r+="&nbsp;";return r+="</div>"}function toHtml(e){e=(0,_sanitizeHtml2["default"])(e,{allowedTags:[],allowedAttributes:[]});var r=parse(e),t="",i=_getDirectiveValue(r,"title"),n=_getDirectiveValue(r,"subtitle");return(i||n)&&(t+='<div class="song-title-section">',i&&(t+='<div class="song-title">'+i+"</div>"),n&&(t+='<div class="song-subtitle">'+n+"</div>"),t+="</div>"),r.forEach(function(e){t+=_formatParsedLine(e)}),t}function _getDirectiveValue(e,r){var t=!0,i=!1,n=void 0;try{for(var s,l=e[Symbol.iterator]();!(t=(s=l.next()).done);t=!0){var o=s.value;if(o.directives){var a=o.directives.find(function(e,t,i){return e.type===r});if(a)return a.value}}}catch(c){i=!0,n=c}finally{try{!t&&l["return"]&&l["return"]()}finally{if(i)throw n}}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.parse=parse,exports._getSegmentStartIndexes=_getSegmentStartIndexes,exports._getChordHtml=_getChordHtml,exports._getLyricsHtml=_getLyricsHtml,exports.toHtml=toHtml;var _sanitizeHtml=require("sanitize-html"),_sanitizeHtml2=_interopRequireDefault(_sanitizeHtml),_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);