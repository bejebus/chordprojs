"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function parse(e){var t=[],r=/^\s*#.*/;return e.split("\n").forEach(function(e){e.match(r)||t.push(_parseLine(e))}),t}function _parseLine(e){for(var t={line:e,lyrics:"",chords:[],directives:[]},r=/\[([a-zA-Z0-9#\/]+)\]/g,i=/\{\s*([^:}]*)\s*:{0,1}\s*([^:]*?)\s*}/g,n=[];l=r.exec(e);)l.type="chord",n.push(l);for(;l=i.exec(e);)l.type="directive",n.push(l);n.sort(function(e,t){return e.index-t.index});var s,l,o=0,a=!0,c=!1,u=void 0;try{for(var d,v=n[Symbol.iterator]();!(a=(d=v.next()).done);a=!0){var f=d.value;if(s=e.substring(o,f.index),s&&(t.lyrics+=s),"chord"==f.type){var h=0;if(t.chords.length>0){var g=t.chords[t.chords.length-1];h=Math.max(0,g.pos+g.value.length+1-t.lyrics.length)}for(var p=0;h>p;p++)t.lyrics+=" ";var y=f[0];t.chords.push({pos:t.lyrics.length,value:y.replace(/[\[\]]/g,"")}),o=f.index+y.length}else if("directive"==f.type){var _=f[0];t.directives.push({pos:t.lyrics.length,type:_getDirectiveType(f[1]),value:f[2]}),o=f.index+_.length}}}catch(m){c=!0,u=m}finally{try{!a&&v["return"]&&v["return"]()}finally{if(c)throw u}}return s=e.substring(o,e.length),s&&(t.lyrics+=s),t.lyrics=t.lyrics.replace(/\s+$/,""),t}function _getDirectiveType(e){return e=e.toLowerCase(),"t"===e?"title":"st"===e?"subtitle":"c"===e?"comment":e}function _formatParsedLine(e){var t=_getSegmentStartIndexes(e);if(0==e.line.length)return'<div class="line"><div class="linefragment"><div class="lyrics">&nbsp;</div></div></div>';for(var r="",i=0;i<t.length;i++)r+='<div class="linefragment">',e.chords&&e.chords.length&&(r+=_getChordHtml(e.chords,t[i])),r+=_getLyricsHtml(e.lyrics,t[i],i<t.length-1?t[i+1]-1:null),r+="</div>";return r?'<div class="line">'+r+"</div>":""}function _getSegmentStartIndexes(e){function t(e,t){for(var r=e.index,i=1;t>i;i++)r+=e[i].length;return r}var r=[];if(e.lyrics)for(var i,n=/(\s*)([^\s]+)/g;i=n.exec(e.lyrics);){var s=t(i,2);_underscore2["default"].find(e.chords,function(e){return s>e.pos&&s<=e.pos+e.value.length})||r.push(s)}if(e.chords){var l=!0,o=!1,a=void 0;try{for(var c,u=e.chords[Symbol.iterator]();!(l=(c=u.next()).done);l=!0){var d=c.value;_underscore2["default"].contains(r,d.pos)||r.push(d.pos)}}catch(v){o=!0,a=v}finally{try{!l&&u["return"]&&u["return"]()}finally{if(o)throw a}}}return r.sort(function(e,t){return e-t}),r}function _getChordHtml(e,t){var r,i='<div class="chord">';return e&&(r=_underscore2["default"].find(e,function(e){return e.pos==t})),i+=r?r.value:"&nbsp;",i+="</div>"}function _getLyricsHtml(e,t,r){var i='<div class="lyrics">';return t>e.length-1?i+="&nbsp;":(r||(r=e.length-1),i+=e.substring(t,r+1)),i+="</div>"}function toHtml(e){e=(0,_sanitizeHtml2["default"])(e,{allowedTags:[],allowedAttributes:[]});var t=parse(e),r="",i=_getDirectiveValue(t,"title"),n=_getDirectiveValue(t,"subtitle");return(i||n)&&(r+='<div class="song-title-section">',i&&(r+='<div class="song-title">'+i+"</div>"),n&&(r+='<div class="song-subtitle">'+n+"</div>"),r+="</div>"),t.forEach(function(e){r+=_formatParsedLine(e)}),r}function _getDirectiveValue(e,t){var r=!0,i=!1,n=void 0;try{for(var s,l=e[Symbol.iterator]();!(r=(s=l.next()).done);r=!0){var o=s.value;if(o.directives){var a=o.directives.find(function(e,r,i){return e.type===t});if(a)return a.value}}}catch(c){i=!0,n=c}finally{try{!r&&l["return"]&&l["return"]()}finally{if(i)throw n}}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.parse=parse,exports._getSegmentStartIndexes=_getSegmentStartIndexes,exports._getChordHtml=_getChordHtml,exports._getLyricsHtml=_getLyricsHtml,exports.toHtml=toHtml;var _sanitizeHtml=require("sanitize-html"),_sanitizeHtml2=_interopRequireDefault(_sanitizeHtml),_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);