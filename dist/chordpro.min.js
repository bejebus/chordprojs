"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function parse(e){var t=[],r=/^\s*#.*/;return e.split("\n").forEach(function(e){e.match(r)||t.push(parseLine(e))}),t}function parseLine(e){for(var t={line:e,lyrics:"",chords:[],directives:[]},r=/\[([a-zA-Z0-9#\/]+)\]/g,n=/\{\s*([^:}]*)\s*:{0,1}\s*([^:]*?)\s*}/g,i=[];a=r.exec(e);)a.type="chord",i.push(a);for(;a=n.exec(e);)a.type="directive",i.push(a);i.sort(function(e,t){return e.index-t.index});var l,a,o=0,s=!0,c=!1,u=void 0;try{for(var h,f=i[Symbol.iterator]();!(s=(h=f.next()).done);s=!0){var v=h.value;if(l=e.substring(o,v.index),l&&(t.lyrics+=l),"chord"==v.type){var d=0;if(t.chords.length>0){var p=t.chords[t.chords.length-1];d=Math.max(0,p.pos+p.value.length+1-t.lyrics.length)}for(var y=0;d>y;y++)t.lyrics+=" ";var g=v[0];t.chords.push({pos:t.lyrics.length,value:g.replace(/[\[\]]/g,"")}),o=v.index+g.length}else if("directive"==v.type){var m=v[0];t.directives.push({pos:t.lyrics.length,type:getDirectiveType(v[1]),value:v[2]}),o=v.index+m.length}}}catch(x){c=!0,u=x}finally{try{!s&&f["return"]&&f["return"]()}finally{if(c)throw u}}return l=e.substring(o,e.length),l&&(t.lyrics+=l),t.lyrics=t.lyrics.replace(/\s+$/,""),t}function getDirectiveType(e){return e=e.toLowerCase(),"t"===e?"title":"st"===e?"subtitle":"c"===e?"comment":e}function formatParsedLine(e,t){function r(e,r){var n=e.replace(/(<([^>]+)>)/gi,""),i=r.pos-n.length;i>0&&(e+=Array(i+1).join(" "));var l=r.value;return t&&t.chordFormatter&&(l=t.chordFormatter(l)),e+=l}var n="",i=!0,l=!1,a=void 0;try{for(var o,s=e.directives[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){o.value}}catch(c){l=!0,a=c}finally{try{!i&&s["return"]&&s["return"]()}finally{if(l)throw a}}if(e.chords.length>0){n.length>0&&(n+=t.newLine);var u="";e.chords.forEach(function(e){u=r(u,e)}),n+=u}return(e.lyrics.length>0||0===e.chords.length&&0===e.directives.length)&&(n.length>0&&(n+=t.newLine),n+=e.lyrics),n}function format(e,t){e=(0,_sanitizeHtml2["default"])(e,{allowedTags:[],allowedAttributes:[]});var r=parse(e);t||(t={}),t.newLine||(t.newLine="\n");var n="",i=getDirectiveValue(r,"title");i&&(t&&t.titleFormatter&&(i=t.titleFormatter(i)),n+=i);var l=getDirectiveValue(r,"subtitle");return l&&(n.length>0&&(n+=t.newLine),t&&t.subtitleFormatter&&(l=t.subtitleFormatter(l)),n+=l),n.length>0&&(n+=t.newLine),r.forEach(function(e){n.length>0&&(e.lyrics.length>0||e.chords.length>0||0==e.line.length)&&(n+=t.newLine),n+=formatParsedLine(e,t)}),n}function getDirectiveValue(e,t){var r=!0,n=!1,i=void 0;try{for(var l,a=e[Symbol.iterator]();!(r=(l=a.next()).done);r=!0){var o=l.value;if(o.directives){var s=o.directives.find(function(e,r,n){return e.type===t});if(s)return s.value}}}catch(c){n=!0,i=c}finally{try{!r&&a["return"]&&a["return"]()}finally{if(n)throw i}}}function toText(e){return format(e)}function toHtml(e,t){t||(t={}),t.chordFormatter||(t.chordFormatter=function(e){return"<b>"+e+"</b>"}),t.titleFormatter||(t.titleFormatter=function(e){return"<h1>"+e+"</h1>"}),t.subtitleFormatter||(t.subtitleFormatter=function(e){return"<h2>"+e+"</h2>"}),t.newLine||(t.newLine="<br/>");var r="<pre>";return t["class"]&&(r='<pre class="'+t["class"]+'">'),r+format(e,t)+"</pre>"}Object.defineProperty(exports,"__esModule",{value:!0}),exports.parse=parse,exports.toText=toText,exports.toHtml=toHtml;var _sanitizeHtml=require("sanitize-html"),_sanitizeHtml2=_interopRequireDefault(_sanitizeHtml);