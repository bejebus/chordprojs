"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function parse(e){var r=[],t=/^\s*#.*/;return e.split("\n").forEach(function(e){e.match(t)||r.push(_parseLine(e))}),r}function _parseLine(e){var r=[];""===e&&r.push({lyrics:"&nbsp;"});for(var t=0;t<e.length;){var a={},s=_parseDirective(e.substring(t,e.length));if(s)a.directive=s,t+=s.source.length;else{var i=_parseChord(e.substring(t,e.length));i&&(a.chord=i.value,t+=i.source.length);var n=_parseWhitespace(e.substring(t,e.length));if(n)a.lyrics=n,t+=n.length;else{var o=_parseWord(e.substring(t,e.length));o&&(a.lyrics=o,t+=o.length)}}r.push(a)}return r}function _parseChord(e,r){var r=/^\[([a-zA-Z0-9#\/]*)\]/,t=r.exec(e);return t?{source:t[0],value:t[1]}:void 0}function _parseDirective(e,r){var r=/^\{\s*([^:}]*)\s*:{0,1}\s*([^:]*?)\s*}/,t=r.exec(e);return t?{source:t[0],type:_getDirectiveType(t[1]),value:t[2]}:void 0}function _parseWord(e,r){var r=/^([^\s\[\{]*)/,t=r.exec(e);return t?t[1]:void 0}function _parseWhitespace(e,r){var r=/^([\s]*)/,t=r.exec(e);return t?t[1]:void 0}function _getDirectiveType(e){switch(e=e.toLowerCase()){case"t":return"title";case"st":return"subtitle";case"c":return"comment";default:return e}}function _formatDirective(e){switch(e.type){case"title":return'<span class="song-title">'+e.value+"</span>";case"subtitle":return'<span class="song-subtitle">'+e.value+"</span>";case"comment":return'<span class="song-comment">'+title+"</span>";case"soc":return'<div class="song-soc">';case"eoc":return"</div>";case"soh":return'<div class="song-soh">';case"eoh":return"</div>";default:return""}}function _formatChord(e){return'<span class="song-chord">'+e+"</span>"}function _formatLyrics(e){e||(e=" ");var r=e.match(/^\s*$/);return'<span class="song-lyrics'+(r?' song-lyrics-whitespace">':'">')+e+"</span>"}function _formatParsedLine(e){var r="";r+='<span class="song-line">';var t=_lodash2["default"].find(e,function(e){return e.chord}),a=!0,s=!1,i=void 0;try{for(var n,o=e[Symbol.iterator]();!(a=(n=o.next()).done);a=!0){var c=n.value;if(r+='<span class="song-linesegment">',c.directive)r+=_formatDirective(c.directive);else{if(t){var l=c.chord?c.chord:" ";r+=_formatChord(l)}r+=_formatLyrics(c.lyrics)}r+="</span>"}}catch(u){s=!0,i=u}finally{try{!a&&o["return"]&&o["return"]()}finally{if(s)throw i}}return r+="</span>"}function toHtml(e){e=(0,_sanitizeHtml2["default"])(e,{allowedTags:[],allowedAttributes:[]});var r=parse(e),t="";return r.forEach(function(e){t+=_formatParsedLine(e)}),t}function getMetadata(e){var r={},t=parse(e);return r.title=_getDirectiveValue(t,"title"),r.subtitle=_getDirectiveValue(t,"subtitle"),r}function _getDirectiveValue(e,r){var t=!0,a=!1,s=void 0;try{for(var i,n=e[Symbol.iterator]();!(t=(i=n.next()).done);t=!0){var o=i.value,c=!0,l=!1,u=void 0;try{for(var p,v=o[Symbol.iterator]();!(c=(p=v.next()).done);c=!0){var d=p.value;if(d.directive&&d.directive.type===r)return d.directive.value}}catch(f){l=!0,u=f}finally{try{!c&&v["return"]&&v["return"]()}finally{if(l)throw u}}}}catch(f){a=!0,s=f}finally{try{!t&&n["return"]&&n["return"]()}finally{if(a)throw s}}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.parse=parse,exports._parseLine=_parseLine,exports._parseChord=_parseChord,exports._parseDirective=_parseDirective,exports._parseWord=_parseWord,exports._parseWhitespace=_parseWhitespace,exports.toHtml=toHtml,exports.getMetadata=getMetadata;var _sanitizeHtml=require("sanitize-html"),_sanitizeHtml2=_interopRequireDefault(_sanitizeHtml),_lodash=require("lodash"),_lodash2=_interopRequireDefault(_lodash);